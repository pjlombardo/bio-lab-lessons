---
title: "Applying ANOVA to Experiment Data"
output: 
    learnr::tutorial:
        theme: "journal"
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(dplyr)
library(ggplot2)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE)
experiment <- read.csv('data/experiment_data.csv', header = T)
final_df<-experiment %>%
    filter(Time=="72hr") %>%
    select(Treatment,Lesion.mm,pH)
```

## Understanding the experiment
In this lesson, we will learn how to use Analysis of Variance (ANOVA) to test for statistically significant differences in means for three treatment groups. The data, and the description below, were generously provided by Dr. Grace Kwan.

#### Abstract

*Pectobacterium carotovorum is a commonly found bacterial pathogen that rots plant tissues. You have probably seen P. carotovorum in action if you have ever left some fresh produce in the refrigerator too long and came back to a slimy, watery mess. This bacterium uses enzymes to break down plant cell walls, causing the plant cells to burst from osmotic pressure and release all of their water and nutrients -- nutrients that support the continued growth of the bacterial pathogen.*

*Enzymes typically have optimal pH at which they work best. Above or below this optimal pH, the enzyme's activity diminishes. Pathogens may need to regulate the pH of their environment in order to ensure that their enzymes function optimally. *

*This experiment assessed the importance of environmental pH on the ability of P. carotovorum to break down plant tissues (i.e., rot them). P. carotovorum uses the BudB protein to limit acid production by providing an alternate fermentation pathway that results in a product of neutral pH.*

### Experiment details
The experiment monitored several lettuce leaves within each treatment class:

* Three control leaves without bacteria (`Control`)
* Nine leaves inoculated with wild-type P. carotovorum (`Wild`), and
* Nine leaves inoculated with $\Delta$budB mutant (`budB`).

At 24, 48, and 72 hours, disease progression was monitored as the length of the soft rot area in millimeters (`Lesion.mm`). At 72 hours, the soft rotted tissue was mashed up to evaluate the pH. 

***We are primarily interested in differences in lesion length and pH between the treatment groups at the end of the experiment.***


### Exploring the data
Run the code block below to become familiar with the data, as well as the format of the data.  We store the information in the `experiment` data frame. Remember you can use "Next" button in the lower left to see more rows of the data.
```{r p-value, exercise = TRUE, exercise.lines=3}
experiment
```
*Note:* The data is in "tidy" format already. This means that each row corresponds to a measurement taken on a given leave at a particular time point (24hr, 48hr, or 72hr).  Each endpoint metric, as well as a time and treatment labels, are stored in their own columns.^[Also note that `pH` has `NA` values whenever `Time` is not equal to 72 hours; this is because we do not measure pH until the end of the experiment.]

> Important Idea: In order for the ANOVA code in this lesson to work properly, the data *must* be in tidy format!


```{r dependent-question}
question("Read the description of the \"Experiment Details\" once more. Of the variables in the data frame, which correspond to measurements that we will use to compare the treatment groups at the end of the experiment. *Select all that apply.*",
    answer("Leaf_ID"),
    answer("pH", correct = TRUE),
    answer("Treatment"),
    answer("Time"),
    answer("Lesion.mm",correct = TRUE),
    answer("Sample"),
    allow_retry = T,
    random_answer_order = T,
    incorrect = paste(random_encouragement(),"What metrics will we use to differentiate the treatment groups? See the \"Experiment Details\" section."),
    post_message = random_praise()
  )
```

```{r independent-question}
question("Which variable in the data frame identifies the groups we want to compare?",
    answer("Leaf_ID"),
    answer("pH"),
    answer("Treatment", correct = TRUE),
    answer("Time"),
    answer("Lesion.mm"),
    answer("Sample"),
    allow_retry = T,
    random_answer_order = T,
    incorrect = paste(random_encouragement(),"Remember we are looking for differences between wild type, budB mutant, and the control. What variable helps us keep these groups straight?"),
    post_message = random_praise()
  )
```

### Great work so far!
We are now acquainted (or re-acquainted) with the data, and we have identified the appropriate variables of interest for our ANOVA. In the next sections, we will review the process of running an ANOVA to compare the mean lesion length at the end of the experiment for each treatment group. Our final section will provide an opportunity to test your skills by doing the same analysis with `pH` as the endpoint metric. 

Shall we get started?

## Quick ANOVA review {data-progressive=TRUE}

Let's get started with a quick review of analysis of variance.  ANOVA is a statistical hypothesis test used to "compare population means for several populations" based on evidence from samples collected from these populations. But what do we mean by "compare"?

As a hypothesis test, ANOVA is equipped with a *null hypothesis*, which we hope our samples will provide evidence ***against***.  For an ANOVA, the null hypothesis is

> $H_0$: the population means are equal across *all* groups.<br>  ($\mu_{_\text{group 1}} = \mu_{_\text{group 2}} = \mu_{_\text{group 3}} = \dots = \mu_{_\text{group $k$}}$)

As with all hypothesis tests, we either conclude by

* **rejecting $H_0$**: this means our samples (more specifically, *sample means*) provided enough evidence to suggest *at least one group mean* is different from the rest.
* **failing to reject $H_0$**: this means our samples did not provide enough evidence to suggest that the group means are different at the population level.

### A new perspective
There is another way to view ANOVA that help makes some of the `R` code more intuitive. ANOVA is a test that, like others, provides a method of testing for an ***association*** between an *independent variable* and a *dependent variable*.  Roughly speaking:

* **Independent variable:** this is typically a variable that researchers have some control over, and they let it vary to test for some sort of response in the *dependent variable.*

* **Independent variable:** this is typically a variable that researchers use to measure the response to potential changes in an *independent variable*.  The researchers cannot (and should not) control what this variable is doing!

When looking for an association, we are simply asking:

> *Does knowing something about the **independent variable** give us information about what will happen with the **dependent variable**?

For an ANOVA, we also require (among other assumptions) that:

* the *independent variable* is a categorical (grouping) variable, with at least three potential levels (groups); and
* the *dependent variable* is a quantitative variable.

So translating the ideas above, an ANOVA attempts to answer the question:

> Does knowing something about a *grouping variable* give us information about a *quantitative measurement*?

```{r grouping-question}
question("In the P. carotovorum experiment, what variable from the data frame do we think of as the researcher controlling and varying for the purpose of looking for some sort of response?",
    answer("Sample"),
    answer("pH"),
    answer("Treatment", correct = TRUE),
    answer("Lesion.mm"),
    allow_retry = T,
    random_answer_order = T,
    incorrect = paste(random_encouragement(),"Remember we inoculated lettuce leaves with different bacteria: wild type, budB mutant, and the control (no inoculation). What variable helps us keep these groups straight?"),
    post_message = paste(random_praise(), "The `Treatment` variable is our independent variable for this experiment. We might also call it our grouping variable, if we already know we are running an ANOVA.")
  )
```

```{r response-question}
question("In the P. carotovorum experiment, what variable or variables from the data frame do we think of as measuring the *response* to changes administered by the researcher?",
    answer("Sample", message=paste(random_encouragement(),"Remember the effectiveness of P. carotovorum in rotting the leaf can be monitored by the growth/size of rot lesion, and we expect that bacteria in certain groups will also try to control the pH of the rot lesion.")),
    answer("pH", correct = TRUE),
    answer("Treatment", message=paste(random_encouragement(),"Remember the effectiveness of P. carotovorum in rotting the leaf can be monitored by the growth/size of rot lesion, and we expect that bacteria in certain groups will also try to control the pH of the rot lesion.")),
    answer("Lesion.mm", correct = TRUE),
    allow_retry = T,
    random_answer_order = T,
    post_message = paste(random_praise(), "The `pH` and the `Lesion.mm` are potential dependent variables for this experiment. This means we could run two ANOVAs <ul> <li> one comparing how pH responds to Treatment, and</li> <li>one comparing how lesion length responds to Treatment.</li></ul>")
  )
```

#### Keep up the great work!

## Getting ready{data-progressive=TRUE}
In the previous section we determined our data for the *P. carotovorum* experiment could potentially inform *two* different ANOVAs.  For demonstration, we will focus on the ANOVA with

* **Independent variable** is `Treatment`, differentiating the groups of lettuce leaves that were inoculated differently (or not at all, as is the case with the control); and
* **Dependent variable** is `Lesion.mm`, a response measuring the efficacy of the inoculated bacteria at rotting the leaf.

(*Note:* We will save the ANOVA involving `pH` for the review exercises.)

Many `R` functions, and statistical analyses, require the researcher to specify the independent and dependent variables in their code.  In `R`, we can do this quickly using the syntax `dependent_var ~ indendent_var`. 

So, for our case, we will often see code that uses `Lesion.mm ~ Treatment`.

### Preparing our analysis data frame
Recall that we are only analyzing data from the *end of the experiment.* This means we want rows where `Time` equals (`==`) the "72hr" mark.  Use the code chunk below to do the following:

* Use the `filter()` command to keep only rows with data from the end of the experiment; and
* Use the `select()` command to keep the `Treatment`, `Lesion.mm`, and `pH` variables.

Sift through the code to verify that you have the data you need to continue.
```{r filter, exercise = TRUE, exercise.lines=3}
experiment %>%
    filter(...) %>%
    select(...)
```
```{r filter-hint-1}
experiment %>%
    filter(...) %>%
    select(Treatment, Lesion.mm, pH)
```
```{r filter-hint-2}
experiment %>%
    filter(Time == "...") %>%
    select(Treatment, Lesion.mm, pH)
```
```{r filter-solution}
experiment %>%
    filter(Time == "72hr") %>%
    select(Treatment, Lesion.mm, pH)
```
**Answer Check:** There should be 21 rows in this data frame, and three columns.
<br>
We have stored this data frame under the shortcut name `final_df`. We will use it for the rest of the sections and exercises. For now, we will focus on `Lesion.mm` as our dependent variable and pursue that particular ANOVA. We will not use `pH` until the review exercises.

#### Great work!
In the next two sections, we will fit an ANOVA and explore the whether there are differences in the mean lesion length among our three treatment groups: `Wild`, `budB`, and `Control`.

Here we go!

## Running an ANOVA {data-progressive=TRUE}
```{r aov-setup, include = FALSE}
experiment %>%
    filter(Time == "72hr") %>%
    select(Treatment, Lesion.mm, pH)->final_df
lesion.aov<-aov(Lesion.mm ~ Treatment, data = final_df)
```

In `R`, we use the `aov()` function to "fit" an ANOVA.  In its simplest application, which is fine for us, it uses two arguments:

* `formula`: which we use to specify the dependent and independent variables (`Lesion.mm ~ Treatment`), and
* `data`: which we use to identify the data frame with our data (`final_df`).

The syntax is `aov(depend_var ~ indep_var, data = df_name)`.

#### Exercise: Fit an ANOVA!
Fill in the code below to fit an ANOVA and save the output to the name `lesion.aov`.  The last line calls the saved output so you can see that it worked.
```{r aov1, exercise = TRUE, exercise.lines=3, exercise.setup="aov-setup"}
lesion.aov <- aov(...)
lesion.aov
```
```{r aov1-hint-1}
lesion.aov <- aov(..., data = final_df)
lesion.aov
```
```{r aov1-hint-2}
lesion.aov <- aov(Lesion.mm ~ ..., data = final_df)
lesion.aov
```
```{r aov1-solution}
lesion.aov <- aov(Lesion.mm ~ Treatment, data = final_df)
lesion.aov
```
**Answer Check:** You should see some output, but perhaps not what you were expecting.  If this worked, however, you will find `Residual standard error: 18.77679`.

### ANOVA results and interpretation
Yes... we're all thinking the same thing.  ***Where's my $P$-value!?***

The default report from the `aov()` function does not report a $P$-value, but we can get it easily.  Since we saved the ANOVA output under the name `lesion.aov`, we can use other functions to get more information.

One such function is `summary()`, which will create a standard ANOVA table, and also report our $P$-value for the hypothesis test.

#### Exercies: extract the ANOVA table and the $P$-value
Put our saved ANOVA, `lesion.aov`, inside the `summary()` function to see a new output!
```{r get-p, exercise = TRUE, exercise.lines=3, exercise.setup="aov-setup"}
summary(...)
```
```{r get-p-solution}
summary(lesion.aov)
```
**Answer Check**: You should see a new output table with a value of `0.0136` below a column heading of `Pr(>F)`.

### Interpreting our summary output
So, *where the $P$-value*?  Great question!

It's not obvious, but the value below the column heading `Pr(>F)` is the $P$-value for this ANOVA. So, for our ANOVA involving potential differences in mean lesion length between our treatment groups, *we have a $P$-value of 0.0136.*


***KEEP GOING FROM HERE***

But, what does that mean? Notice that the $P$-value is ***smaller than*** 0.05 (a standard threshold used for comparison). 

In broad terms, our sample provides sufficient evidence to suggest there is an association between the `Treatment` variable and the `Lesion.mm` variable.



## Tukey's Honest Significant Difference Test
output and check-all-that apply to see which have "sig differences"

Visualizing pair-wise difference in means?

## Practice exercises 
same analysis but for pH by Treatment


***

## Example Exercises

### Exercise 

*Here's a simple exercise with an empty code chunk provided for entering the answer.*

Write the R code required to add two plus two:

```{r two-plus-two, exercise=TRUE}

```

### Exercise with Code

*Here's an exercise with some prepopulated code as well as `exercise.lines = 5` to provide a bit more initial room to work.*

Now write a function that adds any two numbers and then call it:

```{r add-function, exercise=TRUE, exercise.lines = 5}
add <- function() {
  
}
```

## Topic 2

### Exercise with Hint

*Here's an exercise where the chunk is pre-evaluated via the `exercise.eval` option (so the user can see the default output we'd like them to customize). We also add a "hint" to the correct solution via the chunk immediate below labeled `print-limit-hint`.*

Modify the following code to limit the number of rows printed to 5:

```{r print-limit, exercise=TRUE, exercise.eval=TRUE}
mtcars
```

```{r print-limit-hint}
head(mtcars)
```


### Shiny Example
```{r, echo=FALSE}
sliderInput("bins", "Number of bins:", min = 1, max = 50, value = 30)
plotOutput("distPlot")
```

```{r, context="server"}
output$distPlot <- renderPlot({
  x <- faithful[, 2]  # Old Faithful Geyser data
  bins <- seq(min(x), max(x), length.out = input$bins + 1)
  hist(x, breaks = bins, col = 'darkgray', border = 'white')
})
```

### Quiz

*You can include any number of single or multiple choice questions as a quiz. Use the `question` function to define a question and the `quiz` function for grouping multiple questions together.*

Some questions to verify that you understand the purposes of various base and recommended R packages:

```{r quiz}
quiz(
  question("Which package contains functions for installing other R packages?",
    answer("base"),
    answer("tools"),
    answer("utils", correct = TRUE),
    answer("codetools")
  ),
  question("Which of the R packages listed below are used to create plots?",
    answer("lattice", correct = TRUE),
    answer("tools"),
    answer("stats"),
    answer("grid", correct = TRUE)
  )
)
```

